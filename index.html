<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <script>
    /****************************************************
     * ‚úÖ CSP-safe Alert/Confirm (Fallback for SweetAlert)
     ****************************************************/
    (function(){
      function stripHtml(html){
        return String(html || '')
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<\/p>/gi, '\n')
          .replace(/<[^>]*>/g, '')
          .replace(/\n{3,}/g, '\n\n')
          .trim();
      }

      window.Swal = window.Swal || {
        fire: async (opt) => {
          const title = opt?.title || '';
          const text = opt?.text || stripHtml(opt?.html || '');
          if (opt?.showCancelButton) {
            const ok = confirm(title + (text ? "\n\n" + text : ""));
            return { isConfirmed: ok };
          } else {
            alert(title + (text ? "\n\n" + text : ""));
            return { isConfirmed: true };
          }
        },
        showLoading: ()=>{},
        close: ()=>{}
      };

      window.toast = function(icon, title){
        console.log(`[${icon}] ${title}`);
      };
    })();
  </script>

  <style>
    :root{
      --bg1:#fff7ff;
      --bg2:#f0fbff;
      --card:#ffffffcc;
      --text:#111827;
      --muted:#6b7280;
      --p1:#ff4fa3;
      --p2:#7c5cff;
      --p3:#22c55e;
      --p4:#f59e0b;
      --line:#e5e7eb;
      --shadow: 0 16px 44px rgba(31,41,55,.12);
      --r: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Kanit',sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, #ffe6f2 0%, transparent 55%),
        radial-gradient(1200px 700px at 90% 15%, #e6f1ff 0%, transparent 55%),
        radial-gradient(900px 600px at 60% 95%, #e7fff1 0%, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }
    .blob{ position:fixed; pointer-events:none; opacity:.6; }
    .b1{ width:260px; height:260px; left:-70px; top:120px;
      background: radial-gradient(circle at 30% 30%, #ff4fa3, transparent 60%),
                  radial-gradient(circle at 70% 70%, #7c5cff, transparent 60%);
      border-radius: 60% 40% 60% 40% / 50% 60% 40% 60%;
      transform: rotate(12deg);
    }
    .b2{ width:320px; height:320px; right:-90px; top:200px;
      background: radial-gradient(circle at 30% 30%, #22c55e, transparent 60%),
                  radial-gradient(circle at 70% 70%, #f59e0b, transparent 60%);
      border-radius: 55% 45% 40% 60% / 55% 40% 60% 45%;
      transform: rotate(-8deg);
    }
    .b3{ width:420px; height:420px; left:20%; bottom:-220px;
      background: radial-gradient(circle at 30% 30%, #60a5fa, transparent 60%),
                  radial-gradient(circle at 70% 70%, #fb7185, transparent 60%);
      border-radius: 45% 55% 60% 40% / 50% 45% 55% 50%;
    }

    .wrap{ max-width:1180px; margin:0 auto; padding:24px 18px 70px; position:relative; }
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:16px 18px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.7);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:48px; height:48px; border-radius:16px;
      background: linear-gradient(135deg, var(--p1), var(--p2));
      display:grid; place-items:center;
      color:#fff; font-weight:900;
      box-shadow: 0 12px 26px rgba(124,92,255,.25);
    }
    .title{ line-height:1.1; }
    .title h1{ margin:0; font-size:18px; font-weight:900; }
    .title .sub{ font-size:12px; color:var(--muted); }

    .btn{
      border:0; cursor:pointer;
      padding:10px 14px;
      border-radius: 14px;
      font-weight:800;
      background: #111827;
      color:#fff;
      transition:.15s transform;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.soft{ background: #ffffff; color:#111827; border:1px solid var(--line); }
    .btn.grad{ background: linear-gradient(135deg, var(--p1), var(--p2)); }
    .btn.warn{ background: linear-gradient(135deg, #fb7185, #f59e0b); }
    .btn.lock{ background: linear-gradient(135deg, #0ea5e9, #7c5cff); }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:18px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.7);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:16px;
    }
    .card h2{ margin:0 0 10px; font-size:16px; }
    .muted{ color:var(--muted); font-size:13px; }
    .small{ font-size:12px; color:var(--muted); }

    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .chip{
      background:#fff; border:1px solid var(--line);
      border-radius: 999px; padding:10px 12px;
      display:flex; gap:10px; align-items:center;
      box-shadow: 0 8px 18px rgba(31,41,55,.06);
      cursor:pointer;
      transition: .12s transform, .12s box-shadow;
    }
    .chip:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(31,41,55,.10); }
    .dot{ width:10px; height:10px; border-radius:99px; background:var(--p2); }
    .dot.g{ background:var(--p3); }
    .dot.o{ background:var(--p4); }
    .dot.p{ background:var(--p1); }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    @media (max-width:560px){ .row{ grid-template-columns:1fr; } }
    .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .field input, .field select{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      font-family:'Kanit',sans-serif;
      font-size:14px;
    }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }

    .kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px;}
    @media (max-width:560px){ .kpis{ grid-template-columns:1fr; } }
    .kpi{
      background:#fff; border:1px solid var(--line);
      border-radius: 16px; padding:12px;
    }
    .kpi .n{ font-size:20px; font-weight:900; }
    .kpi .t{ color:var(--muted); font-size:12px; }

    .tableWrap{ overflow:auto; border:1px solid var(--line); border-radius: 16px; background:#fff; }
    table{ border-collapse:collapse; width:100%; min-width: 980px; }
    th, td{ padding:10px 10px; border-bottom:1px solid #f3f4f6; font-size:13px; text-align:left; vertical-align:top; }
    th{ position:sticky; top:0; background:#fafafa; z-index:2; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
      border:1px solid var(--line);
      white-space:nowrap;
    }
    .pill.ok{ background:#ecfdf5; border-color:#bbf7d0; }
    .pill.no{ background:#fff1f2; border-color:#fecdd3; }

    .bar{ height:10px; background:#f3f4f6; border-radius:999px; overflow:hidden; }
    .bar > div{ height:100%; width:0%; background:linear-gradient(90deg, var(--p1), var(--p2)); }

    .hintBox{
      margin-top:10px;
      padding:12px;
      border:1px dashed rgba(124,92,255,.35);
      border-radius:16px;
      background: rgba(124,92,255,.06);
    }
    .foot{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
    }
    code.badge{
      background:#fff;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
    }

    /* Admin modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(17,24,39,.45);
      display:none; align-items:center; justify-content:center; padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(520px, 100%); background:#fff; border-radius:20px; padding:16px;
      box-shadow: 0 22px 60px rgba(0,0,0,.25);
      border:1px solid rgba(229,231,235,.9);
    }
    .modal h3{ margin:0 0 8px; }
    .modal .muted{ margin:0 0 10px; }
    .modal .row{ margin-top:8px; }
    .modal .actions{ justify-content:flex-end; }
    .adminChip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:#fff; border:1px solid var(--line);
      font-size:12px; font-weight:800;
    }
    .adminChip.on{ border-color:#bbf7d0; background:#ecfdf5; }
  </style>
</head>

<body>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üè†</div>
        <div class="title">
          <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569</h1>
          <div class="sub">‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö GitHub Pages ‚Ä¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Gmail ‚Ä¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Apps Script API (JSONP)</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center">
        <span id="adminBadge" class="adminChip">üîí ‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô: ‡∏õ‡∏¥‡∏î</span>
        <button class="btn soft" onclick="refreshAll()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button class="btn lock" onclick="openAdmin()">üîí ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>üìå ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á)</h2>
        <div class="muted">
          ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏£‡∏ß‡∏° ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ 300 ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô/‡πÄ‡∏ó‡∏≠‡∏° ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞ 7 ‡∏ö‡∏≤‡∏ó
        </div>

        <div class="hintBox">
          <div style="font-weight:900">‚ú® ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å (‡∏™‡∏£‡∏∏‡∏õ)</div>
          <div class="small">
            ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á: ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á+‡∏ó‡∏µ‡πà‡∏ô‡∏≠‡∏ô 3.5 ‡∏ü‡∏∏‡∏ï, ‡∏û‡∏±‡∏î‡∏•‡∏°‡πÇ‡∏Ñ‡∏à‡∏£, ‡∏ï‡∏π‡πâ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤, ‡πÇ‡∏ï‡πä‡∏∞+‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ, (‡πÅ‡∏≠‡∏£‡πå‡∏ö‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)<br>
            ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç, ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡∏ß‡∏µ, CCTV, ‡∏£‡∏õ‡∏†.24‡∏ä‡∏°., ‡∏Ñ‡∏µ‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î, ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á
          </div>
        </div>

        <div id="roomList" class="chips"></div>

        <hr style="border:none; border-top:1px solid rgba(229,231,235,.7); margin:14px 0;">

        <h2>üìù ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å (‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)</h2>
        <div class="row">
          <div class="field">
            <label for="fullName">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤)</label>
            <input id="fullName" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" autocomplete="name">
          </div>
          <div class="field">
            <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input id="phone" type="tel" placeholder="‡πÄ‡∏ä‡πà‡∏ô 08xxxxxxxx" autocomplete="tel">
          </div>
          <div class="field">
            <label for="major">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤</label>
            <input id="major" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•">
          </div>
          <div class="field">
            <label for="faculty">‡∏Ñ‡∏ì‡∏∞</label>
            <input id="faculty" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ì‡∏∞‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">
          </div>
          <div class="field" style="grid-column:1/-1">
            <label for="roomTypeId">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</label>
            <select id="roomTypeId"></select>
            <div class="small" id="roomHint" style="margin-top:6px;"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn grad" onclick="submitReservation()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
          <button class="btn soft" onclick="clearForm()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        </div>

        <div class="foot">
          <div class="small">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô Apps Script Web App (JSONP)</div>
          <code class="badge" id="apiBadge">API: -</code>
        </div>

        <hr style="border:none; border-top:1px solid rgba(229,231,235,.7); margin:14px 0;">
        <h2>üßæ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h2>
        <div class="muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡πÇ‡∏î‡∏¢‡∏õ‡∏Å‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á PDPA</div>
        <div class="tableWrap" style="margin-top:12px;">
          <table style="min-width: 820px;">
            <thead>
              <tr>
                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠ (‡∏õ‡∏Å‡∏õ‡∏¥‡∏î)</th>
                <th>‡∏Ñ‡∏ì‡∏∞ (‡∏õ‡∏Å‡∏õ‡∏¥‡∏î)</th>
                <th>‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏õ‡∏Å‡∏õ‡∏¥‡∏î)</th>
                <th>‡πÇ‡∏ó‡∏£ (‡∏õ‡∏Å‡∏õ‡∏¥‡∏î)</th>
                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</th>
                <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏ó‡∏≠‡∏°</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody id="publicBody"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>üìä Dashboard</h2>
        <div class="kpis">
          <div class="kpi">
            <div class="n" id="kCap">0</div>
            <div class="t">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏ô)</div>
          </div>
          <div class="kpi">
            <div class="n" id="kBooked">0</div>
            <div class="t">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏ô)</div>
          </div>
          <div class="kpi">
            <div class="n" id="kRemain">0</div>
            <div class="t">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Ñ‡∏ô)</div>
          </div>
        </div>

        <div id="dashCards" style="margin-top:12px; display:grid; gap:10px;"></div>

        <div class="hintBox" style="margin-top:14px;">
          <div style="font-weight:900">üîí ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</div>
          <div class="muted">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</div>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn warn" id="btnTest" onclick="adminOnly(testConnection)" disabled>üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API</button>
          <button class="btn" id="btnReport" onclick="adminOnly(openReport)" disabled>üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)</button>
          <button class="btn soft" id="btnExcel" onclick="adminOnly(openExcel)" disabled>üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Excel export ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets (‡∏ú‡∏π‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏µ‡∏ï)
        </div>
      </div>
    </div>

    <!-- ADMIN REPORT -->
    <div id="reportCard" class="card" style="margin-top:18px; display:none;">
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
        <div>
          <h2 style="margin:0;">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)</h2>
          <div class="muted">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (BOOKED / CANCELLED)</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn soft" onclick="hideReport()">‚úñ ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
          <button class="btn" onclick="openExcel()">üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <input id="q" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏Ñ‡∏ì‡∏∞ / ‡∏™‡∏≤‡∏Ç‡∏≤ / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó / ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á"
               style="flex:1; min-width:240px; padding:11px 12px; border-radius:14px; border:1px solid var(--line); font-family:'Kanit',sans-serif;">
        <button class="btn soft" onclick="renderReport()">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button class="btn soft" onclick="document.getElementById('q').value=''; renderReport();">üßº ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>

      <div class="tableWrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>CreatedAt</th>
              <th>ResvID</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
              <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
              <th>‡∏Ñ‡∏ì‡∏∞</th>
              <th>‡πÇ‡∏ó‡∏£</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏ó‡∏≠‡∏°</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="reportBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminBack" class="modalBack" onclick="closeAdmin(event)">
    <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
      <h3>üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h3>
      <p class="muted">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>

      <div class="row">
        <div class="field">
          <label for="adminUser">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
          <input id="adminUser" type="text" autocomplete="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
        </div>
        <div class="field">
          <label for="adminPass">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input id="adminPass" type="password" autocomplete="current-password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
        </div>
      </div>

      <div class="actions">
        <button class="btn soft" onclick="closeAdmin()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn lock" onclick="loginAdmin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>

      <div class="small" style="margin-top:8px;">
        * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
      </div>
    </div>
  </div>

  <script>
    /**********************
     *  ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
     **********************/
    const API_URL = "https://script.google.com/macros/s/AKfycbx27u8fgUh4hIby9_OzOmRJbn3fTUILLy9FMnB5We1qga17XMcimCIDdTpJiYDX5UiA5g/exec";

    const state = {
      roomTypes: [],
      dashboard: null,
      reservations: [],
      isAdmin: false
    };

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    }
    function setHint(text){ document.getElementById('roomHint').textContent = text || ''; }

    function setApiBadge(){
      const el = document.getElementById('apiBadge');
      const short = API_URL.replace(/^https?:\/\//,'').slice(0,48) + (API_URL.length>51?'...':'');
      el.textContent = "API: " + short;
    }

    /**********************
     * ‚úÖ JSONP Call (‡πÅ‡∏Å‡πâ CORS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GitHub Pages)
     **********************/
    function callApi(action, payload){
      return new Promise((resolve) => {
        const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*100000);
        const qs = new URLSearchParams();
        qs.set("action", action);
        qs.set("callback", cb);
        if(payload && Object.keys(payload).length){
          qs.set("payload", JSON.stringify(payload));
        }

        const url = API_URL + (API_URL.includes("?") ? "&" : "?") + qs.toString();

        let done = false;
        const timer = setTimeout(() => {
          if(done) return;
          done = true;
          try { delete window[cb]; } catch(_){}
          script.remove();
          resolve({ ok:false, message:"Fetch failed/timeout (JSONP)" });
        }, 15000);

        window[cb] = (data) => {
          if(done) return;
          done = true;
          clearTimeout(timer);
          try { delete window[cb]; } catch(_){}
          script.remove();
          resolve(data);
        };

        const script = document.createElement("script");
        script.src = url;
        script.onerror = () => {
          if(done) return;
          done = true;
          clearTimeout(timer);
          try { delete window[cb]; } catch(_){}
          script.remove();
          resolve({ ok:false, message:"JSONP failed" });
        };

        document.body.appendChild(script);
      });
    }

    /**********************
     * ‚úÖ Admin mode (‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå user/pass)
     **********************/
    function setAdminUI(on){
      state.isAdmin = !!on;
      const badge = document.getElementById('adminBadge');
      badge.textContent = on ? "üîì ‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô: ‡πÄ‡∏õ‡∏¥‡∏î" : "üîí ‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô: ‡∏õ‡∏¥‡∏î";
      badge.classList.toggle('on', on);

      ["btnTest","btnReport","btnExcel"].forEach(id=>{
        const b = document.getElementById(id);
        b.disabled = !on;
        b.style.opacity = on ? "1" : ".65";
        b.style.cursor = on ? "pointer" : "not-allowed";
      });
    }

    function openAdmin(){
      document.getElementById('adminBack').style.display = 'flex';
      setTimeout(()=>document.getElementById('adminUser').focus(), 50);
    }

    function closeAdmin(ev){
      if(ev && ev.target && ev.target.id !== 'adminBack') return;
      document.getElementById('adminBack').style.display = 'none';
      document.getElementById('adminUser').value = '';
      document.getElementById('adminPass').value = '';
    }

    function loginAdmin(){
      const u = (document.getElementById('adminUser').value||'').trim();
      const p = (document.getElementById('adminPass').value||'').trim();

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö local (‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ô UI)
      const ok = (u === "sam" && p === "1900");
      if(!ok){
        Swal.fire({icon:'error', title:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:'‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'});
        return;
      }
      closeAdmin();
      setAdminUI(true);
      toast('success','‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
    }

    function adminOnly(fn){
      if(!state.isAdmin){
        openAdmin();
        return;
      }
      fn();
    }

    /**********************
     * ‚úÖ PDPA masking
     **********************/
    function maskName(fullName){
      const s = String(fullName||'').trim();
      if(!s) return '-';
      const parts = s.split(/\s+/).filter(Boolean);
      if(parts.length === 1){
        // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß: ‡πÅ‡∏™‡∏î‡∏á 1 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ + ***
        const a = parts[0];
        return a.slice(0,1) + "***";
      }
      // ‡∏ä‡∏∑‡πà‡∏≠ + ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
      const first = parts[0];
      const last  = parts[parts.length-1];
      const f = first.slice(0,1) + "***";
      const l = last.slice(0,1) + "***";
      return f + " " + l;
    }

    function maskPhone(phone){
      const s = String(phone||'').replace(/\s+/g,'');
      if(s.length < 4) return "***";
      const head = s.slice(0,3);
      const tail = s.slice(-2);
      return head + "*****" + tail;
    }

    function maskTextShort(s){
      s = String(s||'').trim();
      if(!s) return '-';
      if(s.length <= 4) return s.slice(0,1) + "***";
      return s.slice(0,2) + "***";
    }

    /**********************
     * ‚úÖ Load / Render
     **********************/
    async function refreshAll(){
      setApiBadge();

      Swal.showLoading();

      const rt = await callApi("getRoomTypes");
      if(!rt || !rt.ok){
        Swal.close();
        await Swal.fire({icon:'error', title:'‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: rt?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ API'});
        return;
      }

      // ‚úÖ ‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏≠‡∏≠‡∏Å: ‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° TypeName + PricePerTerm
      const raw = rt.data || [];
      const map = new Map();
      raw.forEach(t=>{
        const key = `${t.typeName}__${t.pricePerTerm}`;
        if(!map.has(key)){
          map.set(key, {
            roomTypeId: t.roomTypeId,  // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            typeName: t.typeName,
            pricePerTerm: Number(t.pricePerTerm||0),
            capacityPersons: 0,
            notes: t.notes || ''
          });
        }
        const obj = map.get(key);
        obj.capacityPersons += Number(t.capacityPersons||0); // ‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏ó‡∏∏‡∏Å‡∏´‡∏≠‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
      });

      state.roomTypes = Array.from(map.values())
        .sort((a,b)=> a.pricePerTerm - b.pricePerTerm || String(a.typeName).localeCompare(String(b.typeName)));

      buildRoomList();
      buildRoomSelect();

      const d = await callApi("getDashboard");
      Swal.close();

      if(!d || !d.ok){
        await Swal.fire({icon:'error', title:'‡πÇ‡∏´‡∏•‡∏î Dashboard ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: d?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ API'});
        return;
      }

      // dashboard cards: ‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° TypeName+Price ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
      const cardsRaw = (d.data?.cards || []);
      const m2 = new Map();
      cardsRaw.forEach(c=>{
        const key = `${c.typeName}__${c.pricePerTerm}`;
        if(!m2.has(key)){
          m2.set(key, {
            typeName: c.typeName,
            pricePerTerm: Number(c.pricePerTerm||0),
            capacityPersons: 0,
            booked: 0
          });
        }
        const o = m2.get(key);
        o.capacityPersons += Number(c.capacityPersons||0);
        o.booked += Number(c.booked||0);
      });

      const cards = Array.from(m2.values()).map(o=>{
        const remaining = Math.max(0, o.capacityPersons - o.booked);
        const percent = o.capacityPersons>0 ? Math.round((o.booked/o.capacityPersons)*100) : 0;
        return { ...o, remaining, percent };
      }).sort((a,b)=> a.pricePerTerm - b.pricePerTerm || String(a.typeName).localeCompare(String(b.typeName)));

      const totals = cards.reduce((acc, c) => {
        acc.capacity += c.capacityPersons;
        acc.booked += c.booked;
        acc.remaining += c.remaining;
        return acc;
      }, { capacity: 0, booked: 0, remaining: 0 });

      state.dashboard = { totals, cards };
      renderDashboard();

      // ‡πÇ‡∏´‡∏•‡∏î public list ‡πÄ‡∏™‡∏°‡∏≠
      await refreshPublicList();

      toast('success','‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
    }

    function buildRoomList(){
      const el = document.getElementById('roomList');
      if(!state.roomTypes.length){
        el.innerHTML = '<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</div>';
        return;
      }
      const dots = ['p','g','o',''];
      el.innerHTML = state.roomTypes.map((t,i)=>`
        <div class="chip" onclick="selectType('${t.roomTypeId}')">
          <span class="dot ${dots[i%dots.length]}"></span>
          <div>
            <div style="font-weight:900">${escapeHtml(t.typeName)}</div>
            <div class="muted" style="font-size:12px">
              ‡∏£‡∏≤‡∏Ñ‡∏≤ <b>${Number(t.pricePerTerm).toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô/‡πÄ‡∏ó‡∏≠‡∏° ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° <b>${Number(t.capacityPersons).toLocaleString()}</b> ‡∏Ñ‡∏ô
            </div>
          </div>
        </div>
      `).join('');
    }

    function buildRoomSelect(){
      const sel = document.getElementById('roomTypeId');
      sel.innerHTML = state.roomTypes.map(t=>`
        <option value="${escapeHtml(t.roomTypeId)}">${escapeHtml(t.typeName)} (${Number(t.pricePerTerm).toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ó‡∏≠‡∏°)</option>
      `).join('');
      sel.onchange = ()=> updateHintByType(sel.value);
      if(state.roomTypes[0]) updateHintByType(state.roomTypes[0].roomTypeId);
    }

    function updateHintByType(id){
      const t = state.roomTypes.find(x=>x.roomTypeId===id);
      if(!t){ setHint(''); return; }
      setHint(`‡∏£‡∏≤‡∏Ñ‡∏≤ ${Number(t.pricePerTerm).toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô/‡πÄ‡∏ó‡∏≠‡∏° ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° ${Number(t.capacityPersons).toLocaleString()} ‡∏Ñ‡∏ô ‚Ä¢ ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏£‡∏ß‡∏° ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ 300 ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô/‡πÄ‡∏ó‡∏≠‡∏° ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞ 7 ‡∏ö‡∏≤‡∏ó`);
    }

    function selectType(id){
      document.getElementById('roomTypeId').value = id;
      updateHintByType(id);
      toast('info', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
      window.scrollTo({top: 260, behavior:'smooth'});
    }

    function clearForm(){
      ['fullName','major','faculty','phone'].forEach(id=>document.getElementById(id).value='');
      toast('success','‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß');
    }

    async function submitReservation(){
      const payload = {
        fullName: document.getElementById('fullName').value.trim(),
        major: document.getElementById('major').value.trim(),
        faculty: document.getElementById('faculty').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        roomTypeId: document.getElementById('roomTypeId').value
      };

      if(!payload.fullName || !payload.major || !payload.faculty || !payload.phone || !payload.roomTypeId){
        await Swal.fire({icon:'warning', title:'‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á'});
        return;
      }

      const type = state.roomTypes.find(x=>x.roomTypeId === payload.roomTypeId);
      const typeText = type ? `${type.typeName} (${Number(type.pricePerTerm).toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ó‡∏≠‡∏°)` : payload.roomTypeId;

      const c = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á?',
        html: `<div style="text-align:left; font-size:14px">
          <div><b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${escapeHtml(payload.fullName)}</div>
          <div><b>‡∏™‡∏≤‡∏Ç‡∏≤:</b> ${escapeHtml(payload.major)}</div>
          <div><b>‡∏Ñ‡∏ì‡∏∞:</b> ${escapeHtml(payload.faculty)}</div>
          <div><b>‡πÇ‡∏ó‡∏£:</b> ${escapeHtml(payload.phone)}</div>
          <div><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> ${escapeHtml(typeText)}</div>
        </div>`,
        icon:'question',
        showCancelButton:true,
        confirmButtonText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        cancelButtonText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      });
      if(!c.isConfirmed) return;

      Swal.showLoading();
      const r = await callApi("createReservation", payload);
      Swal.close();

      if(!r || !r.ok){
        await Swal.fire({icon:'error', title:'‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: r?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ API'});
        return;
      }

      await Swal.fire({icon:'success', title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:`${r.message}\n‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ${r.data?.resvId || '-'}`});
      clearForm();
      await refreshAll(); // ‡∏à‡∏∞‡∏£‡∏ß‡∏° public list ‡∏î‡πâ‡∏ß‡∏¢
    }

    function renderDashboard(){
      const d = state.dashboard;
      if(!d) return;

      document.getElementById('kCap').textContent = Number(d.totals?.capacity||0).toLocaleString();
      document.getElementById('kBooked').textContent = Number(d.totals?.booked||0).toLocaleString();
      document.getElementById('kRemain').textContent = Number(d.totals?.remaining||0).toLocaleString();

      const wrap = document.getElementById('dashCards');
      wrap.innerHTML = (d.cards||[]).map(c=>`
        <div class="kpi">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
            <div>
              <div style="font-weight:900">${escapeHtml(c.typeName)}</div>
              <div class="muted">‡∏£‡∏≤‡∏Ñ‡∏≤ ${Number(c.pricePerTerm).toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ó‡∏≠‡∏° ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ${Number(c.capacityPersons).toLocaleString()} ‡∏Ñ‡∏ô ‚Ä¢ ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ${Number(c.booked).toLocaleString()} ‡∏Ñ‡∏ô ‚Ä¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${Number(c.remaining).toLocaleString()} ‡∏Ñ‡∏ô</div>
            </div>
            <div class="pill ${c.remaining>0?'ok':'no'}">
              ${c.remaining>0?'üü¢ ‡∏ß‡πà‡∏≤‡∏á':'üî¥ ‡πÄ‡∏ï‡πá‡∏°'} ‚Ä¢ ${Number(c.percent||0)}%
            </div>
          </div>
          <div class="bar" style="margin-top:10px;"><div style="width:${Number(c.percent||0)}%;"></div></div>
        </div>
      `).join('');
    }

    /**********************
     * ‚úÖ Public list (PDPA)
     **********************/
    async function refreshPublicList(){
      const res = await callApi("listReservations");
      if(!res || !res.ok){
        document.getElementById('publicBody').innerHTML =
          `<tr><td colspan="8" class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${escapeHtml(res?.message||'')}</td></tr>`;
        return;
      }

      // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ BOOKED ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤ filter ‡∏≠‡∏≠‡∏Å)
      const rows = (res.data || []).filter(r=>String(r.Status)==='BOOKED');

      const tb = document.getElementById('publicBody');
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.CreatedAt)}</td>
          <td><b>${escapeHtml(maskName(r.FullName))}</b></td>
          <td>${escapeHtml(maskTextShort(r.Faculty))}</td>
          <td>${escapeHtml(maskTextShort(r.Major))}</td>
          <td>${escapeHtml(maskPhone(r.Phone))}</td>
          <td>${escapeHtml(r.TypeName || '-')}</td>
          <td>${Number(r.PricePerTerm||0).toLocaleString()}</td>
          <td><span class="pill ok">‚úÖ BOOKED</span></td>
        </tr>
      `).join('') || `<tr><td colspan="8" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</td></tr>`;
    }

    /**********************
     * ‚úÖ Admin functions (‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
     **********************/
    async function testConnection(){
      Swal.showLoading();
      const r = await callApi("getDashboard");
      Swal.close();
      if(r && r.ok) await Swal.fire({icon:'success', title:'‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', text:'API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'});
      else await Swal.fire({icon:'error', title:'‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: r?.message || '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'});
    }

    async function openExcel(){
      const res = await callApi("getExportExcelUrl");
      const url = res?.data?.url;
      if(!url){
        await Swal.fire({icon:'error', title:'‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: res?.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel'});
        return;
      }
      window.open(url, "_blank");
    }

    async function openReport(){
      document.getElementById('reportCard').style.display = 'block';
      window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});

      Swal.showLoading();
      const res = await callApi("listReservations");
      Swal.close();

      if(!res || !res.ok){
        await Swal.fire({icon:'error', title:'‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: res?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ API'});
        return;
      }
      state.reservations = res.data || [];
      renderReport();
    }

    function hideReport(){
      document.getElementById('reportCard').style.display = 'none';
      window.scrollTo({top: 0, behavior:'smooth'});
    }

    function renderReport(){
      const q = (document.getElementById('q').value || '').trim().toLowerCase();
      const rows = (state.reservations || []).filter(r=>{
        if(!q) return true;
        const s = [
          r.CreatedAt, r.ResvID, r.FullName, r.Major, r.Faculty, r.Phone,
          r.TypeName, r.RoomTypeID, r.Status
        ].map(x=>String(x||'').toLowerCase()).join(' ');
        return s.includes(q);
      });

      const tb = document.getElementById('reportBody');
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.CreatedAt)}</td>
          <td><b>${escapeHtml(r.ResvID)}</b></td>
          <td>${escapeHtml(r.FullName)}</td>
          <td>${escapeHtml(r.Major)}</td>
          <td>${escapeHtml(r.Faculty)}</td>
          <td>${escapeHtml(r.Phone)}</td>
          <td>${escapeHtml(r.TypeName || '-')}</td>
          <td>${Number(r.PricePerTerm||0).toLocaleString()}</td>
          <td>${String(r.Status)==='BOOKED'
            ? '<span class="pill ok">‚úÖ BOOKED</span>'
            : '<span class="pill no">‚õî CANCELLED</span>'}
          </td>
        </tr>
      `).join('') || `<tr><td colspan="9" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    // init
    setApiBadge();
    setAdminUI(false);
    refreshAll();
  </script>
</body>
</html>
