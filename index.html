<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <script>
    /****************************************************
     * ‚úÖ CSP-safe Alert/Confirm (Fallback for SweetAlert)
     ****************************************************/
    (function(){
      function stripHtml(html){
        return String(html || '')
          .replace(/<br\s*\/?>/gi, '\n')
          .replace(/<\/p>/gi, '\n')
          .replace(/<[^>]*>/g, '')
          .replace(/\n{3,}/g, '\n\n')
          .trim();
      }

      window.Swal = window.Swal || {
        fire: async (opt) => {
          const title = opt?.title || '';
          const text = opt?.text || stripHtml(opt?.html || '');
          if (opt?.showCancelButton) {
            const ok = confirm(title + (text ? "\n\n" + text : ""));
            return { isConfirmed: ok };
          } else {
            alert(title + (text ? "\n\n" + text : ""));
            return { isConfirmed: true };
          }
        },
        showLoading: ()=>{},
        close: ()=>{}
      };

      // ‚úÖ toast ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Swal (‡∏Å‡∏±‡∏ô CSP ‡∏ä‡∏±‡∏ß‡∏£‡πå)
      window.toast = function(icon, title){
        console.log(`[${icon}] ${title}`);
      };
    })();
  </script>

  <style>
    :root{
      --bg1:#fff7ff;
      --bg2:#f0fbff;
      --card:#ffffffcc;
      --text:#111827;
      --muted:#6b7280;
      --p1:#ff4fa3;
      --p2:#7c5cff;
      --p3:#22c55e;
      --p4:#f59e0b;
      --line:#e5e7eb;
      --shadow: 0 16px 44px rgba(31,41,55,.12);
      --r: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Kanit',sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, #ffe6f2 0%, transparent 55%),
        radial-gradient(1200px 700px at 90% 15%, #e6f1ff 0%, transparent 55%),
        radial-gradient(900px 600px at 60% 95%, #e7fff1 0%, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }
    .blob{ position:fixed; pointer-events:none; opacity:.6; }
    .b1{ width:260px; height:260px; left:-70px; top:120px;
      background: radial-gradient(circle at 30% 30%, #ff4fa3, transparent 60%),
                  radial-gradient(circle at 70% 70%, #7c5cff, transparent 60%);
      border-radius: 60% 40% 60% 40% / 50% 60% 40% 60%;
      transform: rotate(12deg);
    }
    .b2{ width:320px; height:320px; right:-90px; top:200px;
      background: radial-gradient(circle at 30% 30%, #22c55e, transparent 60%),
                  radial-gradient(circle at 70% 70%, #f59e0b, transparent 60%);
      border-radius: 55% 45% 40% 60% / 55% 40% 60% 45%;
      transform: rotate(-8deg);
    }
    .b3{ width:420px; height:420px; left:20%; bottom:-220px;
      background: radial-gradient(circle at 30% 30%, #60a5fa, transparent 60%),
                  radial-gradient(circle at 70% 70%, #fb7185, transparent 60%);
      border-radius: 45% 55% 60% 40% / 50% 45% 55% 50%;
    }

    .wrap{ max-width:1180px; margin:0 auto; padding:24px 18px 70px; position:relative; }
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:16px 18px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.7);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:48px; height:48px; border-radius:16px;
      background: linear-gradient(135deg, var(--p1), var(--p2));
      display:grid; place-items:center;
      color:#fff; font-weight:900;
      box-shadow: 0 12px 26px rgba(124,92,255,.25);
    }
    .title{ line-height:1.1; }
    .title h1{ margin:0; font-size:18px; font-weight:900; }
    .title .sub{ font-size:12px; color:var(--muted); }

    .btn{
      border:0; cursor:pointer;
      padding:10px 14px;
      border-radius: 14px;
      font-weight:800;
      background: #111827;
      color:#fff;
      transition:.15s transform;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.soft{ background: #ffffff; color:#111827; border:1px solid var(--line); }
    .btn.grad{ background: linear-gradient(135deg, var(--p1), var(--p2)); }
    .btn.warn{ background: linear-gradient(135deg, #fb7185, #f59e0b); }

    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:18px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.7);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:16px;
    }
    .card h2{ margin:0 0 10px; font-size:16px; }
    .muted{ color:var(--muted); font-size:13px; }
    .small{ font-size:12px; color:var(--muted); }

    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .chip{
      background:#fff; border:1px solid var(--line);
      border-radius: 16px; padding:12px 12px;
      display:flex; gap:10px; align-items:flex-start;
      box-shadow: 0 8px 18px rgba(31,41,55,.06);
      cursor:pointer;
      transition: .12s transform, .12s box-shadow;
      width:100%;
    }
    .chip:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(31,41,55,.10); }
    .dot{ width:10px; height:10px; border-radius:99px; background:var(--p2); margin-top:6px; }
    .dot.g{ background:var(--p3); }
    .dot.o{ background:var(--p4); }
    .dot.p{ background:var(--p1); }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    @media (max-width:560px){ .row{ grid-template-columns:1fr; } }
    .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .field input, .field select{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      font-family:'Kanit',sans-serif;
      font-size:14px;
    }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }

    .kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px;}
    @media (max-width:560px){ .kpis{ grid-template-columns:1fr; } }
    .kpi{
      background:#fff; border:1px solid var(--line);
      border-radius: 16px; padding:12px;
    }
    .kpi .n{ font-size:20px; font-weight:900; }
    .kpi .t{ color:var(--muted); font-size:12px; }

    .tableWrap{ overflow:auto; border:1px solid var(--line); border-radius: 16px; background:#fff; }
    table{ border-collapse:collapse; width:100%; min-width: 860px; }
    th, td{ padding:10px 10px; border-bottom:1px solid #f3f4f6; font-size:13px; text-align:left; vertical-align:top; }
    th{ position:sticky; top:0; background:#fafafa; z-index:2; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
      border:1px solid var(--line);
      white-space:nowrap;
    }
    .pill.ok{ background:#ecfdf5; border-color:#bbf7d0; }
    .pill.no{ background:#fff1f2; border-color:#fecdd3; }

    .bar{ height:10px; background:#f3f4f6; border-radius:999px; overflow:hidden; }
    .bar > div{ height:100%; width:0%; background:linear-gradient(90deg, var(--p1), var(--p2)); }

    .hintBox{
      margin-top:10px;
      padding:12px;
      border:1px dashed rgba(124,92,255,.35);
      border-radius:16px;
      background: rgba(124,92,255,.06);
    }
    .foot{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
    }
    code.badge{
      background:#fff;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
    }

    /* admin modal */
    .modalMask{
      position:fixed; inset:0; background:rgba(17,24,39,.35);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:50;
    }
    .modal{
      width:min(520px, 96vw);
      background:#fff;
      border-radius:22px;
      box-shadow: 0 24px 60px rgba(17,24,39,.22);
      border:1px solid rgba(229,231,235,.9);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center;
      background:linear-gradient(135deg, rgba(255,79,163,.12), rgba(124,92,255,.12));
    }
    .modalHead b{font-size:14px;}
    .modalBody{ padding:14px 16px; }
    .modalFoot{ padding:14px 16px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid #f3f4f6; }
    .xbtn{
      border:0; background:transparent; cursor:pointer; font-size:18px; line-height:1;
      padding:6px 10px; border-radius:12px;
    }
    .xbtn:hover{ background:#f3f4f6; }

    .adminBadge{
      display:none;
      padding:6px 10px; border-radius:999px;
      border:1px solid #d1fae5; background:#ecfdf5;
      font-weight:900; font-size:12px;
      color:#065f46;
      align-items:center; gap:6px;
    }
    .adminBadge.on{ display:inline-flex; }
  </style>
</head>

<body>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üè†</div>
        <div class="title">
          <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569</h1>
          <div class="sub">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏ç‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center">
        <span id="adminBadge" class="adminBadge">üîí Admin</span>
        <button class="btn soft" onclick="refreshAll()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button class="btn" onclick="openAdminGate('report')">üß∞ ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>üìå ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á)</h2>
        <div class="muted">
          ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏£‡∏ß‡∏° ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ 300 ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô/‡πÄ‡∏ó‡∏≠‡∏° ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞ 7 ‡∏ö‡∏≤‡∏ó
        </div>

        <div class="hintBox">
          <div style="font-weight:900">‚ú® ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å (‡∏™‡∏£‡∏∏‡∏õ)</div>
          <div class="small">
            ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á: ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á+‡∏ó‡∏µ‡πà‡∏ô‡∏≠‡∏ô 3.5 ‡∏ü‡∏∏‡∏ï, ‡∏û‡∏±‡∏î‡∏•‡∏°‡πÇ‡∏Ñ‡∏à‡∏£, ‡∏ï‡∏π‡πâ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤, ‡πÇ‡∏ï‡πä‡∏∞+‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ (‡πÅ‡∏≠‡∏£‡πå‡∏ö‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)<br>
            ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á: ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç, ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡∏ß‡∏µ, CCTV, ‡∏£‡∏õ‡∏†.24‡∏ä‡∏°., ‡∏Ñ‡∏µ‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î, ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á
          </div>
        </div>

        <div id="roomList" class="chips"></div>

        <hr style="border:none; border-top:1px solid rgba(229,231,235,.7); margin:14px 0;">

        <h2>üìù ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å (‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)</h2>
        <div class="row">
          <div class="field">
            <label for="fullName">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤)</label>
            <input id="fullName" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" autocomplete="name">
          </div>

          <div class="field">
            <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input id="phone" type="tel" placeholder="‡πÄ‡∏ä‡πà‡∏ô 08xxxxxxxx" autocomplete="tel">
          </div>

          <div class="field">
            <label for="major">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤</label>
            <input id="major" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•">
          </div>

          <div class="field">
            <label for="faculty">‡∏Ñ‡∏ì‡∏∞</label>
            <select id="faculty">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ì‡∏∞ --</option>
              <option>‡∏Ñ‡∏£‡∏∏‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
              <option>‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
              <option>‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
              <option>‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
            </select>
          </div>

          <div class="field" style="grid-column:1/-1">
            <label for="roomTypeId">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</label>
            <select id="roomTypeId"></select>
            <div class="small" id="roomHint" style="margin-top:6px;"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn grad" onclick="submitReservation()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
          <button class="btn soft" onclick="clearForm()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        </div>

        <div class="foot">
          <div class="small">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÅ‡∏•‡πâ‡∏ß</div>
          <code class="badge" id="apiBadge">API: -</code>
        </div>

        <!-- PDPA list shown to students -->
        <div class="card" style="margin-top:14px; background:#ffffffcc;">
          <h2 style="margin:0 0 6px;">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</h2>
          <div class="muted">‡πÅ‡∏™‡∏î‡∏á ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏• ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤/‡∏Ñ‡∏ì‡∏∞ ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á</div>

          <div class="tableWrap" style="margin-top:10px;">
            <table style="min-width:820px">
              <thead>
                <tr>
                  <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏õ‡∏Å‡∏õ‡∏¥‡∏î)</th>
                  <th>‡∏Ñ‡∏ì‡∏∞</th>
                  <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
                  <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</th>
                  <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏ó‡∏≠‡∏°</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                </tr>
              </thead>
              <tbody id="publicListBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>üìä Dashboard</h2>
        <div class="kpis">
          <div class="kpi">
            <div class="n" id="kCap">0</div>
            <div class="t">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏ô)</div>
          </div>
          <div class="kpi">
            <div class="n" id="kBooked">0</div>
            <div class="t">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏ô)</div>
          </div>
          <div class="kpi">
            <div class="n" id="kRemain">0</div>
            <div class="t">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Ñ‡∏ô)</div>
          </div>
        </div>

        <div id="dashCards" style="margin-top:12px; display:grid; gap:10px;"></div>

        <div class="actions" style="margin-top:14px;">
          <button class="btn soft" onclick="openAdminGate('test')">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API</button>
          <button class="btn soft" onclick="openAdminGate('excel')">üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel</button>
          <button class="btn" onclick="openAdminGate('report')">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
        </div>
      </div>
    </div>

    <!-- ADMIN REPORT (hidden until admin) -->
    <div id="reportCard" class="card" style="margin-top:18px; display:none;">
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
        <div>
          <h2 style="margin:0;">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)</h2>
          <div class="muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (BOOKED / CANCELLED)</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn soft" onclick="hideReport()">‚úñ ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
          <button class="btn" onclick="openExcel()">üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <input id="q" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏Ñ‡∏ì‡∏∞ / ‡∏™‡∏≤‡∏Ç‡∏≤ / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á / ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á"
               style="flex:1; min-width:240px; padding:11px 12px; border-radius:14px; border:1px solid var(--line); font-family:'Kanit',sans-serif;">
        <button class="btn soft" onclick="renderReport()">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button class="btn soft" onclick="document.getElementById('q').value=''; renderReport();">üßº ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>

      <div class="tableWrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>CreatedAt</th>
              <th>ResvID</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
              <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
              <th>‡∏Ñ‡∏ì‡∏∞</th>
              <th>‡πÇ‡∏ó‡∏£</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏ó‡∏≠‡∏°</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr>
          </thead>
          <tbody id="reportBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="adminMask" class="modalMask" onclick="maskClose(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminTitle" onclick="event.stopPropagation()">
      <div class="modalHead">
        <b id="adminTitle">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</b>
        <button class="xbtn" onclick="closeAdminModal()">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="margin-bottom:10px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</div>
        <div class="row" style="margin-top:0">
          <div class="field">
            <label for="adminUser">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
            <input id="adminUser" type="text" placeholder="Username" autocomplete="username">
          </div>
          <div class="field">
            <label for="adminPass">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            <input id="adminPass" type="password" placeholder="Password" autocomplete="current-password">
          </div>
        </div>
        <div class="small" style="margin-top:10px;">* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
      </div>
      <div class="modalFoot">
        <button class="btn soft" onclick="closeAdminModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn grad" onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </div>

  <script>
    /**********************
     *  ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API
     **********************/
    const API_URL = "https://script.google.com/macros/s/AKfycbx27u8fgUh4hIby9_OzOmRJbn3fTUILLy9FMnB5We1qga17XMcimCIDdTpJiYDX5UiA5g/exec";

    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠: ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡πÉ‡∏ô UI)
    const __ADMIN_USER = "sam";
    const __ADMIN_PASS = "1900";

    const state = {
      roomTypes: [],
      dashboard: null,
      reservations: [],
      isAdmin: false,
      pendingAdminAction: null
    };

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    }

    function setHint(text){
      document.getElementById('roomHint').textContent = text || '';
    }

    function setApiBadge(){
      const el = document.getElementById('apiBadge');
      const short = API_URL.replace(/^https?:\/\//,'').slice(0,44) + (API_URL.length>47?'...':'');
      el.textContent = "API: " + short;
    }

    /****************************************************
     * ‚úÖ JSONP callApi (CORS-free for GitHub Pages)
     ****************************************************/
    function callApi(action, payload){
      return new Promise((resolve) => {
        const cbName = "__jsonp_cb_" + Math.random().toString(36).slice(2);
        const timeoutMs = 15000;

        const timer = setTimeout(() => {
          cleanup();
          resolve({ ok:false, message:"Fetch failed/timeout (jsonp)", raw:"timeout" });
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try { delete window[cbName]; } catch(_) { window[cbName] = undefined; }
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName] = (data) => {
          cleanup();
          resolve(data);
        };

        const url = new URL(API_URL);
        url.searchParams.set("action", action);
        url.searchParams.set("payload", JSON.stringify(payload || {}));
        url.searchParams.set("callback", cbName);

        const script = document.createElement("script");
        script.src = url.toString();
        script.onerror = () => {
          cleanup();
          resolve({ ok:false, message:"Fetch failed/timeout (jsonp)", raw:"script.onerror" });
        };

        document.body.appendChild(script);
      });
    }

    /**********************
     * PDPA helpers
     **********************/
    function maskFullNameLast3(name){
      const s = String(name || '').trim();
      if(!s) return '';
      const n = s.length;
      if(n <= 3) return '*'.repeat(n);
      return s.slice(0, n-3) + '***';
    }

    function fmtMoney(n){
      const x = Number(n||0);
      return x.toLocaleString();
    }

    function normalizeTypeName(typeName){
      // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á "‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏Ñ‡∏π‡πà " ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
      return String(typeName || '').trim();
    }

    /**********************
     * Build room types (no dorm names)
     **********************/
    function buildRoomList(){
      const el = document.getElementById('roomList');
      if(!state.roomTypes.length){
        el.innerHTML = '<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</div>';
        return;
      }

      // ‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° TypeName + Price (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏≠‡πÅ‡∏ï‡πà‡∏ä‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
      const group = {};
      state.roomTypes.forEach(t=>{
        const key = `${t.typeName}__${t.pricePerTerm}`;
        if(!group[key]){
          group[key] = { ...t, _ids:[t.roomTypeId], _cap: Number(t.capacityPersons||0) };
        }else{
          group[key]._ids.push(t.roomTypeId);
          group[key]._cap += Number(t.capacityPersons||0);
        }
      });

      const list = Object.values(group);
      const dots = ['p','g','o',''];

      el.innerHTML = list.map((t,i)=>`
        <div class="chip" onclick="selectGroupType('${escapeHtml(t.typeName)}', ${Number(t.pricePerTerm||0)})">
          <span class="dot ${dots[i%dots.length]}"></span>
          <div style="flex:1">
            <div style="font-weight:900">${escapeHtml(normalizeTypeName(t.typeName))}</div>
            <div class="muted" style="font-size:12px">
              ‡∏£‡∏≤‡∏Ñ‡∏≤ <b>${fmtMoney(t.pricePerTerm)}</b> ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô/‡πÄ‡∏ó‡∏≠‡∏° ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° <b>${fmtMoney(t._cap)}</b> ‡∏Ñ‡∏ô
              ${t.notes ? ` ‚Ä¢ ${escapeHtml(t.notes)}` : ``}
            </div>
          </div>
          <div class="pill ok">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
        </div>
      `).join('');
    }

    function buildRoomSelect(){
      const sel = document.getElementById('roomTypeId');
      // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡πÉ‡∏ô dropdown
      const options = state.roomTypes.map(t=>({
        id: t.roomTypeId,
        label: `${normalizeTypeName(t.typeName)} (${fmtMoney(t.pricePerTerm)} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ó‡∏≠‡∏°)`,
        typeName: t.typeName,
        price: Number(t.pricePerTerm||0),
        cap: Number(t.capacityPersons||0),
        notes: t.notes||''
      }));

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏î‡∏•‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏≠‡∏£‡πå
      options.sort((a,b)=> a.label.localeCompare(b.label,'th'));

      sel.innerHTML = options.map(o=>`
        <option value="${escapeHtml(o.id)}" data-type="${escapeHtml(o.typeName)}" data-price="${o.price}">
          ${escapeHtml(o.label)}
        </option>
      `).join('');

      sel.onchange = ()=> updateHintByType(sel.value);
      if(options[0]) updateHintByType(options[0].id);
    }

    function selectGroupType(typeName, price){
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å option ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á typeName+price
      const sel = document.getElementById('roomTypeId');
      const opts = Array.from(sel.options);
      const found = opts.find(o => (o.getAttribute('data-type')||'') === typeName && Number(o.getAttribute('data-price')||0) === Number(price||0));
      if(found){
        sel.value = found.value;
        updateHintByType(found.value);
        toast('info', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
        window.scrollTo({top: 260, behavior:'smooth'});
      }
    }

    function updateHintByType(id){
      const t = state.roomTypes.find(x=>x.roomTypeId===id);
      if(!t){ setHint(''); return; }
      setHint(`‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ${fmtMoney(t.capacityPersons)} ‡∏Ñ‡∏ô ‚Ä¢ ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏£‡∏ß‡∏° ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ 300 ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô/‡πÄ‡∏ó‡∏≠‡∏° ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞ 7 ‡∏ö‡∏≤‡∏ó ‚Ä¢ ${t.notes||''}`);
    }

    /**********************
     * Dashboard (vacant % = remaining/capacity *100)
     **********************/
    function renderDashboard(){
      const d = state.dashboard;
      if(!d) return;

      document.getElementById('kCap').textContent = fmtMoney(d.totals?.capacity||0);
      document.getElementById('kBooked').textContent = fmtMoney(d.totals?.booked||0);
      document.getElementById('kRemain').textContent = fmtMoney(d.totals?.remaining||0);

      // ‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠)
      const group = {};
      (d.cards||[]).forEach(c=>{
        const key = `${c.typeName}__${c.pricePerTerm}`;
        if(!group[key]){
          group[key] = {
            typeName: c.typeName,
            pricePerTerm: Number(c.pricePerTerm||0),
            capacityPersons: Number(c.capacityPersons||0),
            booked: Number(c.booked||0),
            remaining: Number(c.remaining||0)
          };
        }else{
          group[key].capacityPersons += Number(c.capacityPersons||0);
          group[key].booked += Number(c.booked||0);
          group[key].remaining += Number(c.remaining||0);
        }
      });

      const cards = Object.values(group).sort((a,b)=> String(a.typeName).localeCompare(String(b.typeName),'th'));
      const wrap = document.getElementById('dashCards');

      wrap.innerHTML = cards.map(c=>{
        const cap = Number(c.capacityPersons||0);
        const remain = Number(c.remaining||0);
        const vacantPercent = cap > 0 ? Math.round((remain / cap) * 100) : 0;

        return `
          <div class="kpi">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <div>
                <div style="font-weight:900">${escapeHtml(normalizeTypeName(c.typeName))}</div>
                <div class="muted">‡∏£‡∏≤‡∏Ñ‡∏≤ ${fmtMoney(c.pricePerTerm)} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ó‡∏≠‡∏° ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ${fmtMoney(cap)} ‡∏Ñ‡∏ô ‚Ä¢ ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ${fmtMoney(c.booked)} ‡∏Ñ‡∏ô ‚Ä¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${fmtMoney(remain)} ‡∏Ñ‡∏ô</div>
              </div>
              <div class="pill ${remain>0?'ok':'no'}">
                ${remain>0?'üü¢ ‡∏ß‡πà‡∏≤‡∏á':'üî¥ ‡πÄ‡∏ï‡πá‡∏°'} ‚Ä¢ ${vacantPercent}%
              </div>
            </div>
            <div class="bar" style="margin-top:10px;">
              <div style="width:${vacantPercent}%;"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    /**********************
     * Public PDPA list
     **********************/
    function renderPublicList(){
      const tb = document.getElementById('publicListBody');
      const rows = (state.reservations||[])
        .filter(r => String(r.Status||'') === 'BOOKED')
        .slice()
        .sort((a,b)=> String(b.CreatedAt||'').localeCompare(String(a.CreatedAt||'')));

      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.CreatedAt)}</td>
          <td><b>${escapeHtml(maskFullNameLast3(r.FullName))}</b></td>
          <td>${escapeHtml(r.Faculty)}</td>
          <td>${escapeHtml(r.Major)}</td>
          <td>${escapeHtml(normalizeTypeName(r.TypeName))}</td>
          <td>${fmtMoney(r.PricePerTerm||0)}</td>
          <td>${String(r.Status)==='BOOKED'
              ? '<span class="pill ok">‚úÖ BOOKED</span>'
              : '<span class="pill no">‚õî CANCELLED</span>'}
          </td>
        </tr>
      `).join('') || `<tr><td colspan="7" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</td></tr>`;
    }

    /**********************
     * Load / Refresh
     **********************/
    async function refreshAll(){
      setApiBadge();

      Swal.showLoading();

      const rt = await callApi("getRoomTypes");
      if(!rt || !rt.ok){
        Swal.close();
        await Swal.fire({icon:'error', title:'‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: rt?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ API'});
        return;
      }
      state.roomTypes = rt.data || [];
      buildRoomList();
      buildRoomSelect();

      const d = await callApi("getDashboard");
      if(!d || !d.ok){
        Swal.close();
        await Swal.fire({icon:'error', title:'‡πÇ‡∏´‡∏•‡∏î Dashboard ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: d?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ API'});
        return;
      }
      state.dashboard = d.data;
      renderDashboard();

      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á PDPA (public)
      const resv = await callApi("listReservations");
      Swal.close();

      if(resv && resv.ok){
        state.reservations = resv.data || [];
        renderPublicList();
      }else{
        // ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ô console
        console.warn("listReservations failed:", resv);
        state.reservations = [];
        renderPublicList();
      }

      toast('success','‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
    }

    /**********************
     * Form
     **********************/
    function clearForm(){
      ['fullName','major','phone'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('faculty').value = '';
      toast('success','‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß');
    }

    async function submitReservation(){
      const payload = {
        fullName: document.getElementById('fullName').value.trim(),
        major: document.getElementById('major').value.trim(),
        faculty: document.getElementById('faculty').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        roomTypeId: document.getElementById('roomTypeId').value
      };

      if(!payload.fullName || !payload.major || !payload.faculty || !payload.phone || !payload.roomTypeId){
        await Swal.fire({icon:'warning', title:'‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á'});
        return;
      }
      if(!/^[0-9+\-\s]{8,20}$/.test(payload.phone)){
        await Swal.fire({icon:'warning', title:'‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'});
        return;
      }

      const type = state.roomTypes.find(x=>x.roomTypeId === payload.roomTypeId);
      const typeText = type ? `${normalizeTypeName(type.typeName)} (${fmtMoney(type.pricePerTerm)} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏ó‡∏≠‡∏°)` : payload.roomTypeId;

      const c = await Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á?',
        html: `<div style="text-align:left; font-size:14px">
          <div><b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${escapeHtml(payload.fullName)}</div>
          <div><b>‡∏™‡∏≤‡∏Ç‡∏≤:</b> ${escapeHtml(payload.major)}</div>
          <div><b>‡∏Ñ‡∏ì‡∏∞:</b> ${escapeHtml(payload.faculty)}</div>
          <div><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> ${escapeHtml(typeText)}</div>
        </div>`,
        icon:'question',
        showCancelButton:true,
        confirmButtonText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        cancelButtonText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      });
      if(!c.isConfirmed) return;

      Swal.showLoading();
      const r = await callApi("createReservation", payload);
      Swal.close();

      if(!r || !r.ok){
        await Swal.fire({icon:'error', title:'‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: r?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ API'});
        return;
      }

      await Swal.fire({icon:'success', title:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:`${r.message}\n‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ${r.data?.resvId || '-'}`});
      clearForm();

      // ‚úÖ ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö PDPA ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      await refreshAll();
      window.scrollTo({top: document.body.scrollHeight * 0.35, behavior:'smooth'});
    }

    /**********************
     * Admin gate
     **********************/
    function openAdminGate(action){
      if(state.isAdmin){
        runAdminAction(action);
        return;
      }
      state.pendingAdminAction = action;
      document.getElementById('adminUser').value = '';
      document.getElementById('adminPass').value = '';
      document.getElementById('adminMask').style.display = 'flex';
      document.getElementById('adminUser').focus();
    }

    function closeAdminModal(){
      document.getElementById('adminMask').style.display = 'none';
      state.pendingAdminAction = null;
    }

    function maskClose(e){
      // click outside modal
      closeAdminModal();
    }

    function adminLogin(){
      const u = String(document.getElementById('adminUser').value || '').trim();
      const p = String(document.getElementById('adminPass').value || '').trim();

      if(u === __ADMIN_USER && p === __ADMIN_PASS){
        state.isAdmin = true;
        document.getElementById('adminBadge').classList.add('on');
        closeAdminModal();
        const act = state.pendingAdminAction;
        state.pendingAdminAction = null;
        runAdminAction(act);
      }else{
        Swal.fire({icon:'error', title:'‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'});
      }
    }

    async function runAdminAction(action){
      if(action === 'test'){
        await testConnection();
        return;
      }
      if(action === 'excel'){
        await openExcel();
        return;
      }
      if(action === 'report'){
        await openReport();
        return;
      }
    }

    async function testConnection(){
      Swal.showLoading();
      const r = await callApi("getDashboard");
      Swal.close();
      if(r && r.ok) await Swal.fire({icon:'success', title:'‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', text:'API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'});
      else await Swal.fire({icon:'error', title:'‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: r?.message || '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'});
    }

    async function openExcel(){
      const res = await callApi("getExportExcelUrl");
      const url = res?.data?.url;
      if(!url){
        await Swal.fire({icon:'error', title:'‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: res?.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel'});
        return;
      }
      window.open(url, "_blank");
    }

    async function openReport(){
      document.getElementById('reportCard').style.display = 'block';
      window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});

      Swal.showLoading();
      const res = await callApi("listReservations");
      Swal.close();

      if(!res || !res.ok){
        await Swal.fire({icon:'error', title:'‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: res?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ API'});
        return;
      }
      state.reservations = res.data || [];
      renderReport();
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï public list ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
      renderPublicList();
    }

    function hideReport(){
      document.getElementById('reportCard').style.display = 'none';
      window.scrollTo({top: 0, behavior:'smooth'});
    }

    function renderReport(){
      const q = (document.getElementById('q').value || '').trim().toLowerCase();
      const rows = (state.reservations || []).filter(r=>{
        if(!q) return true;
        const s = [
          r.CreatedAt, r.ResvID, r.FullName, r.Major, r.Faculty, r.Phone,
          r.TypeName, r.RoomTypeID, r.Status
        ].map(x=>String(x||'').toLowerCase()).join(' ');
        return s.includes(q);
      });

      const tb = document.getElementById('reportBody');
      tb.innerHTML = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.CreatedAt)}</td>
          <td><b>${escapeHtml(r.ResvID)}</b></td>
          <td>${escapeHtml(r.FullName)}</td>
          <td>${escapeHtml(r.Major)}</td>
          <td>${escapeHtml(r.Faculty)}</td>
          <td>${escapeHtml(r.Phone)}</td>
          <td>${escapeHtml(normalizeTypeName(r.TypeName))}</td>
          <td>${fmtMoney(r.PricePerTerm||0)}</td>
          <td>${String(r.Status)==='BOOKED'
            ? '<span class="pill ok">‚úÖ BOOKED</span>'
            : '<span class="pill no">‚õî CANCELLED</span>'}
          </td>
        </tr>
      `).join('') || `<tr><td colspan="9" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    }

    // init
    setApiBadge();
    refreshAll();
  </script>
</body>
</html>
